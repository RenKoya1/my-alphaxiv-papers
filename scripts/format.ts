// scripts/format-folders.ts
import * as fs from "fs";
import * as path from "path";
import { FoldersData } from "../types";

// ãƒ•ã‚©ãƒ«ãƒ€ã‚¿ã‚¤ãƒ—ã«å¯¾å¿œã™ã‚‹çµµæ–‡å­—ã‚’å–å¾—
function getEmojiForFolderType(type: string): string {
  const emojiMap: Record<string, string> = {
    "default-to-read": "ğŸ“–",
    "default-reading": "ğŸ“š",
    "default-completed": "âœ…",
    "default-publications": "ğŸ†",
  };
  return emojiMap[type] || "ğŸ“";
}

try {
  const filePath = path.join(process.cwd(), "data", "folders.json");
  const raw: string = fs.readFileSync(filePath, "utf-8");

  if (!raw.trim()) {
    console.error("âŒ folders.json is empty");
    process.exit(1);
  }

  const parsed: FoldersData = JSON.parse(raw);

  // çµ±è¨ˆæƒ…å ±ã‚’äº‹å‰ã«è¨ˆç®—
  const totalPapers = parsed.data.reduce(
    (sum, folder) => sum + folder.papers.length,
    0
  );

  // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’Markdownã«å¤‰æ›
  let md: string = `# ğŸ“š Research Papers Collection\n\n`;
  md += `> Automatically updated research paper collection organized by reading status\n\n`;
  md += `![Papers](https://img.shields.io/badge/Papers-${totalPapers}-blue) `;
  md += `![Folders](https://img.shields.io/badge/Folders-${parsed.data.length}-green) `;
  md += `![Updated](https://img.shields.io/badge/Updated-${new Date()
    .toISOString()
    .split("T")[0]
    .replace(/-/g, "_")}-orange)\n\n`;

  // çµ±è¨ˆæƒ…å ±ã‚’ä¸Šéƒ¨ã«ç§»å‹•
  md += `## ğŸ“Š Quick Stats\n\n`;
  md += `| Metric | Count |\n`;
  md += `|--------|-------|\n`;
  md += `| ğŸ“ Total Folders | ${parsed.data.length} |\n`;
  md += `| ğŸ“„ Total Papers | ${totalPapers} |\n`;

  parsed.data.forEach((folder) => {
    if (folder.papers.length > 0) {
      const emoji = getEmojiForFolderType(folder.type);
      md += `| ${emoji} ${folder.name} | ${folder.papers.length} |\n`;
    }
  });
  md += `\n---\n\n`;

  // ãƒ•ã‚©ãƒ«ãƒ€ã‚’orderé †ã«ã‚½ãƒ¼ãƒˆ
  const sortedFolders = parsed.data.sort((a, b) => a.order - b.order);

  sortedFolders.forEach((folder) => {
    const emoji = getEmojiForFolderType(folder.type);
    md += `## ${emoji} ${folder.name}\n\n`;

    if (folder.papers.length === 0) {
      md += `> No papers yet.\n\n`;
      return;
    }

    md += `<details open>\n<summary><strong>${folder.papers.length} papers</strong> - Click to expand</summary>\n\n`;

    folder.papers.forEach((paper, index) => {
      const details = paper.details;

      // ArXivã®URLã‚’æŠ½å‡º
      const urlMatch = details.citation?.bibtex?.match(/url=\{(.+?)\}/);
      const url: string =
        urlMatch?.[1] || `https://arxiv.org/abs/${details.paper_id}`;

      // è‘—è€…åã‚’çŸ­ç¸®ï¼ˆæœ€åˆã®3äººã¾ã§ï¼‰
      const authorsText: string =
        details.authors.slice(0, 3).join(", ") +
        (details.authors.length > 3 ? " et al." : "");

      // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      const date: string = details.publication_date.split("T")[0];

      // æŠ•ç¥¨æ•°
      const votes: string = details.public_total_votes
        ? `${details.public_total_votes} votes`
        : "No votes";

      // çµ„ç¹”åã‚’çŸ­ç¸®ï¼ˆæœ€åˆã®2ã¤ã¾ã§ï¼‰
      const orgNames: string =
        details.organizationInfo
          .slice(0, 2)
          .map((org) => org.name)
          .join(", ") + (details.organizationInfo.length > 2 ? " et al." : "");

      md += `### ${index + 1}. [${details.title}](${url})\n\n`;
      md += `**Authors:** ${authorsText}  \n`;
      md += `**ArXiv ID:** \`${details.paper_id}\`  \n`;
      md += `**Published:** ${date}  \n`;
      md += `**Organizations:** ${orgNames || "N/A"}  \n`;
      md += `**Votes:** ${votes}  \n`;

      if (details.abstract) {
        const shortAbstract =
          details.abstract.length > 200
            ? details.abstract.substring(0, 200) + "..."
            : details.abstract;
        md += `**Abstract:** ${shortAbstract}\n\n`;
      }

      if (details.subcategories && details.subcategories.length > 0) {
        md += `**Categories:** ${details.subcategories
          .map((cat) => `\`${cat}\``)
          .join(", ")}\n\n`;
      }

      md += `---\n\n`;
    });

    md += `</details>\n\n`;
  });

  // ãƒ•ãƒƒã‚¿ãƒ¼ã«æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¿½åŠ 
  md += `\n---\n\n`;
  md += `<div align="center">\n\n`;
  md += `**Last Updated:** ${new Date()
    .toISOString()
    .replace("T", " ")
    .substring(0, 19)} UTC\n\n`;
  md += `*This file is automatically generated by the [format script](./scripts/format.ts)*\n\n`;
  md += `</div>\n`;

  fs.writeFileSync("FOLDERS.md", md, "utf-8");
  console.log("âœ… FOLDERS.md generated successfully");
  console.log(`ğŸ“ ${parsed.data.length} folders processed`);
  console.log(`ğŸ“„ ${totalPapers} papers formatted`);
} catch (error) {
  console.error("âŒ Error:", error);
  process.exit(1);
}
